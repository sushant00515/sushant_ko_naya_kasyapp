<!DOCTYPE html>
<html lang="en">
<head>
    <!-- CRITICAL: Ensure responsiveness and disable scaling for app-like experience -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payment Send Screen</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'app-green': '#00d048', 
                        'app-gray': '#f0f0f0',
                        // Primary text color is pure black for maximum contrast and brightness
                        'dark-text': '#000000', 
                        // Secondary text is a medium gray for light contrast
                        'light-text': '#737373', 
                        // A few colors for random avatars
                        'rand-red': '#ef4444', 
                        'rand-orange': '#f97316', 
                        'rand-yellow': '#f59e0b', 
                        'rand-green': '#10b981', 
                        'rand-blue': '#3b82f6', 
                        'rand-indigo': '#6366f1',
                        'rand-purple': '#8b5cf6',
                        'rand-pink': '#ec4899',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '.5' },
                        },
                        spin: {
                           from: { transform: 'rotate(0deg)' },
                           to: { transform: 'rotate(360deg)' },
                        }
                    },
                    animation: {
                        pulse: 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        spin: 'spin 1.5s linear infinite', 
                    }
                }
            }
        }
    </script>
    <!-- Include Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: white; /* Ensures environment around the app is bright */
            display: flex;
            justify-content: center;
            min-height: 100vh; 
            margin: 0; 
        }
        /* Optimized for larger mobile screens like iPhone 14 Pro Max */
        #app-container {
            max-width: 430px; 
            width: 100%;
            background-color: white; /* The primary content background MUST be white */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Clips the off-screen success page */
            min-height: 100vh;
            position: relative; 
        }

        /* Custom Checkbox Styling: Square look */
        .app-checkbox {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid #ccc; 
            border-radius: 6px; 
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            background-color: white; 
            flex-shrink: 0; 
        }

        .app-checkbox:checked {
            border-color: #00d048; 
            background-color: #00d048; 
        }

        /* Custom SVG-style checkmark for the checked state */
        .app-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 3px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        /* Uses the new dark-text (#000000) for crispness */
        .input-text {
            font-size: 1.125rem;
            font-weight: 500;
            line-height: 1.75rem;
            color: black; 
        }

        /* Modal specific styles */
        #payment-modal {
            transition: opacity 300ms ease-out;
            pointer-events: none;
            position: fixed; 
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 30;
            display: flex; 
            justify-content: center; 
            align-items: flex-end;
        }
        #payment-modal.open {
            opacity: 1;
            pointer-events: auto;
        }
        #modal-content {
            transition: transform 300ms ease-out;
            max-width: 430px; 
            width: 100%; 
            margin: 0 auto; 
        }
        #payment-modal.open #modal-content {
            transform: translateY(0);
        }

        /* --- Face ID Simulation Modal Styles (Scoped to App Container) --- */
        #face-id-modal {
            position: absolute; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Implementation of 70% dark transparency over the first page */
            background-color: rgba(0, 0, 0, 0.7); 
            z-index: 50;
            display: none; 
            place-items: center;
            opacity: 0;
            transition: opacity 300ms ease-in-out;
            color: white; /* Ensures text inside is white for contrast */
        }

        #face-id-modal.show {
            display: grid;
            opacity: 1;
        }
        
        /* --- Success Page Styles (Scoped to App Container) --- */
        #success-page {
            position: absolute; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 40; 
            /* Start off-screen (hidden) */
            transform: translateY(100%); 
            transition: transform 400ms cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            padding: 16px; 
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
        }

        #success-page.show {
            /* Slide into view after Face ID success */
            transform: translateY(0); 
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-container" class="relative">

        <!-- Header/Navigation Bar - sticky and responsive -->
        <header class="p-4 flex justify-between items-center border-b border-gray-100 sticky top-0 bg-white z-20 w-full">
            <!-- Close button - no message on click -->
            <button onclick="" class="text-xl font-light text-dark-text p-2 rounded-full hover:bg-app-gray transition duration-150">
                &times;
            </button>
            <h1 class="text-xl font-semibold text-dark-text">$599</h1>
            <!-- Pay Button -->
            <button id="pay-button" onclick="handlePayClick()" class="px-4 py-2 bg-app-green text-white font-medium rounded-full opacity-50 cursor-not-allowed">
                Pay
            </button>
        </header>

        <!-- Main Content Section -->
        <main class="p-4 space-y-6 pb-20 bg-white"> <!-- Ensure main content area is explicitly white -->

            <!-- To Field (Search Input) - Minimalist look, no bottom border for separation -->
            <div class="flex items-center space-x-3 pb-3"> 
                <p class="text-lg text-dark-text font-medium w-12 flex-shrink-0">To</p>
                <input type="text" id="to-input" placeholder="Name, $Cashtag, Phone, Email" class="input-text flex-grow placeholder-light-text focus:outline-none" aria-label="Recipient Input">
            </div>

            <!-- For Field (Note Input) - Uses a border top/bottom to create a clean input box separator -->
            <div class="flex items-center space-x-3 pt-3 pb-3 border-t border-b border-gray-100">
                <p class="text-lg text-dark-text font-medium w-12 flex-shrink-0">For</p>
                <input type="text" id="note-input" placeholder="Note (required)" class="input-text flex-grow placeholder-light-text focus:outline-none" aria-label="Note Input">
                <!-- Small Plus/Minus Icon for splitting bill or similar actions -->
                <button onclick="showMessage('Extra features button clicked')" class="text-light-text hover:text-dark-text transition duration-150 flex-shrink-0">
                    <!-- Plus-Minus Stack SVG for extra features -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <line x1="8" y1="17" x2="16" y2="17"></line>
                    </svg>
                </button>
            </div>

            <!-- Cash Balance Display - Removed onclick="openModal()" -->
            <div class="flex items-center justify-between pt-2 pb-4 rounded-lg p-2 -m-2">
                <div class="flex items-center space-x-3">
                    <!-- Cash App $ Icon -->
                    <div class="w-6 h-6 flex items-center justify-center rounded-full bg-app-green text-white font-bold text-sm flex-shrink-0">
                        $
                    </div>
                    <span class="text-lg text-dark-text font-medium whitespace-nowrap">Cash balance: <span class="font-semibold">$33,846.00</span></span>
                </div>
                <!-- Dropdown Arrow Icon - Now just an indicator -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-light-text flex-shrink-0">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>

            <!-- Suggested Contacts Section -->
            <h2 id="suggested-header" class="text-lg font-semibold text-dark-text mb-2 pt-2">Suggested</h2>

            <div id="contacts-list" class="space-y-2">
                <!-- Contacts will be populated here by JavaScript -->
            </div>

        </main>

        <!-- Message Box for Alerts (kept only for utility messages) -->
        <div id="message-box" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 bg-gray-800 text-white rounded-lg shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-30 w-11/12 max-w-xs text-center">
            Action Performed!
        </div>
        
        <!-- Hidden White Card (Modal/Overlay) - Payment Source Modal -->
        <div id="payment-modal">
            <!-- Modal Content - slides up -->
            <div id="modal-content" class="bg-white w-full h-1/2 rounded-t-2xl shadow-2xl p-6 transform translate-y-full">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-dark-text">Select Payment Source</h3>
                    <!-- Close Button for Modal -->
                    <button onclick="closeModal()" class="text-2xl font-light text-dark-text p-1 rounded-full hover:bg-gray-100 transition duration-150">&times;</button>
                </div>
                
                <p class="text-gray-600 mb-4">Choose which balance or card to use for this payment.</p>

                <!-- Example Source Options -->
                <div class="space-y-3">
                     <!-- Selected Source (Cash Balance) -->
                     <div class="p-3 bg-app-gray rounded-lg flex justify-between items-center ring-2 ring-app-green ring-offset-2">
                        <div class="flex items-center space-x-2">
                            <div class="w-5 h-5 flex items-center justify-center rounded-full bg-app-green text-white font-bold text-xs">$</div>
                            <span class="font-semibold text-dark-text">Cash Balance</span>
                        </div>
                        <span class="font-bold text-dark-text">$33,846.00</span>
                     </div>
                     
                     <!-- Other Source -->
                     <div class="p-3 bg-white border border-gray-200 rounded-lg flex justify-between items-center hover:bg-gray-50 transition">
                        <div class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                            <span class="text-dark-text">Visa •••• 1234</span>
                        </div>
                        <span class="text-sm text-light-text">Tap to select</span>
                     </div>

                     <!-- Add Card Button -->
                     <button class="w-full text-center py-3 border border-dashed border-gray-300 rounded-lg text-light-text font-medium hover:bg-gray-50 transition">
                         + Add Debit Card
                     </button>
                </div>
            </div>
        </div>

        <!-- --- Face ID Simulation Modal (Constrained to App Container) --- -->
        <div id="face-id-modal">
            <div class="flex flex-col items-center justify-center space-y-4">
                <div class="relative flex items-center justify-center w-20 h-20">
                    
                    <!-- 1. Scanning Ring (Animating) -->
                    <svg id="face-id-ring" xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#00d048" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="absolute transition-opacity duration-300">
                        <circle cx="12" cy="12" r="10"></circle>
                    </svg>
                    
                    <!-- 2. Neutral Face Icon (Base Icon, changes color/scale on recognition) -->
                    <!-- Changed to text-white for visibility on the dark overlay -->
                    <svg id="icon-neutral-face" xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-white transition-all duration-300 ease-in-out">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>

                    <!-- 3. Approved Icon (Final Success) - Initially hidden -->
                    <svg id="icon-approved-check" xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#00d048" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="opacity-0 transition-opacity duration-300 absolute">
                        <circle cx="12" cy="12" r="10" fill="#00d048" stroke="none" />
                        <polyline points="16 8 10 14 8 12" stroke="white" stroke-width="2.5"></polyline>
                    </svg>
                </div>
                <!-- Removed conflicting text-dark-text class; text color is inherited as white from the modal parent -->
                <p id="face-id-text" class="text-xl font-medium">Scanning Face...</p>
            </div>
        </div>

        <!-- --- Payment Success Page (Constrained to App Container) --- -->
        <!-- This page appears after the Face ID approval. -->
        <div id="success-page">
            <!-- Success Content -->
            <div class="flex flex-col h-full p-4">
                <!-- Close Button (Top Left) -->
                <button onclick="closeSuccessPage()" class="text-3xl font-light text-dark-text self-start p-2 rounded-full hover:bg-gray-100 transition duration-150">
                    &times;
                </button>

                <!-- Confirmation Message (Centered) -->
                <div class="flex flex-col items-center justify-center flex-grow text-center pb-20">
                    <!-- Large Green Checkmark -->
                    <svg id="success-check-icon" xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="#00d048" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-6">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14 9 11"></polyline>
                    </svg>

                    <h2 class="text-3xl font-bold text-dark-text mb-2" id="success-amount">$599</h2>
                    <p class="text-xl text-dark-text font-medium" id="success-message">You sent $599 to [Recipient Name]</p>
                </div>
            </div>

            <!-- Done Button (Bottom Sticky) -->
            <div class="p-4 w-full max-w-sm mx-auto">
                <button onclick="closeSuccessPage()" class="w-full py-4 bg-app-green text-white text-xl font-semibold rounded-full shadow-lg hover:bg-green-600 transition duration-150">
                    Done
                </button>
            </div>
        </div>

    </div>

    <script>
        const colors = [
            'bg-rand-red', 'bg-rand-orange', 'bg-rand-yellow', 'bg-rand-green', 
            'bg-rand-blue', 'bg-rand-indigo', 'bg-rand-purple', 'bg-rand-pink'
        ];
        
        const contactsData = [
            { name: "sinz Vaesau", cashtag: "$sinavvs" }, 
            { name: "Mariah H", cashtag: "$RiahhBabyy" },
            { name: "Sarah Lee", cashtag: "$Famlee885" },
            { name: "Marisa Perez", cashtag: "$mrisa08" },
            { name: "Qwuaneil", cashtag: "$s3rvex1n" },
            { name: "Darien Levario", cashtag: "$darienr6" },
            { name: "Jane Doe", cashtag: "$JDoe123" },
            { name: "Kyle Brown", cashtag: "$KBrown80" },
            { name: "Alice Smith", cashtag: "$ASmithCo" },
            { name: "Robert Jones", cashtag: "$RJonesPay" },
        ];

        const contactsList = document.getElementById('contacts-list');
        const messageBox = document.getElementById('message-box');
        const payButton = document.getElementById('pay-button');
        const toInput = document.getElementById('to-input'); 
        const noteInput = document.getElementById('note-input'); 
        const suggestedHeader = document.getElementById('suggested-header');
        const paymentModal = document.getElementById('payment-modal');
        
        // Elements for the payment flow
        const faceIdModal = document.getElementById('face-id-modal');
        const faceIdText = document.getElementById('face-id-text');
        const successPage = document.getElementById('success-page');
        const successMessageEl = document.getElementById('success-message');

        let searchTimeout;
        let currentRecipientName = ''; // Tracks the name/cashtag for the success message

        // --- Modal Control Functions ---
        function openModal() {
            paymentModal.classList.add('open');
        }

        function closeModal() {
            paymentModal.classList.remove('open');
        }

        // Add event listener to close modal if background is clicked
        paymentModal.addEventListener('click', (e) => {
            if (e.target === paymentModal) {
                closeModal();
            }
        });
        
        /**
         * Closes the success page and returns to the main app view, resetting state.
         */
        function closeSuccessPage() {
            successPage.classList.remove('show');
            
            // Clear all state after successful payment
            toInput.value = '';
            noteInput.value = '';
            currentRecipientName = '';
            Array.from(document.querySelectorAll('.app-checkbox')).forEach(cb => cb.checked = false);
            
            // Re-render to show suggested contacts and update button state
            renderSuggestedContacts(''); 
            suggestedHeader.textContent = 'Suggested';
            updatePayButtonState();
        }
        // --- End Modal Control Functions ---


        /**
         * Returns a random Tailwind color class for avatars.
         */
        function getRandomColor() {
            return colors[Math.floor(Math.random() * colors.length)];
        }

        /**
         * Returns the first letter of the contact's name.
         */
        function getInitial(name) {
            return name.trim().charAt(0).toUpperCase();
        }

        /**
         * Generates the HTML for a single contact item, randomly choosing avatar style.
         * @param {Object} contact
         * @returns {string} HTML string
         */
        function createContactElement(contact) {
            const color = getRandomColor();
            const initial = getInitial(contact.name);
            let avatarContent;
            
            // 50/50 chance for either avatar style
            const useInitialAvatar = Math.random() < 0.5; 

            if (useInitialAvatar) {
                // Option A: Use First Letter Avatar (Colored circle with initial)
                avatarContent = `<span class="text-lg font-semibold">${initial}</span>`;
            } else {
                // Option B: Use Generic Profile Icon (SVG human silhouette)
                avatarContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-white">
                                    <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.023 18.023 0 0 1 12 21.75c-2.305 0-4.47-.611-6.438-1.643a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
                                 </svg>`;
            }
            
            const avatarHtml = `
                <div class="w-10 h-10 ${color} rounded-full flex items-center justify-center text-white flex-shrink-0">
                    ${avatarContent}
                </div>
            `;

            // Generate a unique ID for the checkbox based on the cashtag
            const checkboxId = `contact-${contact.cashtag.substring(1)}`;

            return `
                <label for="${checkboxId}" class="flex items-center justify-between p-2 rounded-xl hover:bg-gray-50 transition duration-150 cursor-pointer">
                    <div class="flex items-center space-x-3 min-w-0 flex-grow">
                        ${avatarHtml}
                        <div class="min-w-0">
                            <p class="text-base font-medium text-dark-text truncate">${contact.name}</p>
                            <p class="text-sm text-light-text truncate">${contact.cashtag}</p>
                        </div>
                    </div>
                    <input type="checkbox" id="${checkboxId}" name="contact-select" class="app-checkbox" 
                           onchange="handleContactSelect(event, '${contact.name.replace(/'/g, "\\'")}', '${contact.cashtag.replace(/'/g, "\\'")}')">
                </label>
            `;
        }

        /**
         * Generates the HTML for the top search result, styled exactly like a contact.
         * @param {string} searchText
         * @returns {string} HTML string
         */
        function createSearchResultElement(searchText) {
            const name = searchText;
            const cashtag = '$' + searchText.trim().replace(/[^a-zA-Z0-9]/g, '').toLowerCase();

            const color = getRandomColor();
            const initial = getInitial(searchText);

            // Always use initial for the search result to match the input text
            const avatarHtml = `
                <div class="w-10 h-10 ${color} rounded-full flex items-center justify-center text-white font-semibold text-lg flex-shrink-0">
                    <span class="text-lg font-semibold">${initial}</span>
                </div>
            `;

            // Use a specific ID for the search result checkbox
            const checkboxId = `contact-search-result`;

            return `
                <label for="${checkboxId}" class="flex items-center justify-between p-2 rounded-xl hover:bg-gray-50 transition duration-150 cursor-pointer mb-2">
                    <div class="flex items-center space-x-3 min-w-0 flex-grow">
                        ${avatarHtml}
                        <div class="min-w-0">
                            <p class="text-base font-medium text-dark-text truncate">${name}</p>
                            <p class="text-sm text-light-text truncate">${cashtag}</p>
                        </div>
                    </div>
                    <!-- Checkbox for the searched term -->
                    <input type="checkbox" id="${checkboxId}" name="contact-select" class="app-checkbox" 
                           onchange="handleContactSelect(event, '${name.replace(/'/g, "\\'")}', '${cashtag.replace(/'/g, "\\'")}')">
                </label>
            `;
        }


        /**
         * Renders suggested contacts, optionally filtering them, ensuring state is preserved.
         * @param {string} filterText
         */
        function renderSuggestedContacts(filterText = '') {
            const filteredContacts = contactsData.filter(contact =>
                contact.name.toLowerCase().includes(filterText.toLowerCase()) ||
                contact.cashtag.toLowerCase().includes(filterText.toLowerCase())
            );

            // Render new contact elements with fresh random icons
            contactsList.innerHTML = filteredContacts.map(createContactElement).join('');
            
            // Re-apply the selection based on the 'To' input value (if any selection was made before search)
            const currentRecipient = toInput.value.trim();
            if (currentRecipient) {
                // Find the checkbox that corresponds to the current 'To' input value
                const targetCheckbox = document.querySelector(`#contacts-list input[type="checkbox"][onchange*="'${currentRecipient.toLowerCase()}'"]`);
                if (targetCheckbox) {
                    targetCheckbox.checked = true;
                }
            }

            // Ensure pay button state is correctly updated after render
            updatePayButtonState();
        }

        /**
         * Renders the search result (the name in the 'To' field) at the top,
         * followed by the filtered list.
         * @param {string} searchText
         */
        function renderSearchContact(searchText) {
            const filterText = searchText.trim();

            if (filterText === '') {
                renderSuggestedContacts('');
                return;
            }

            // 1. Generate the top search result 
            const searchResultHtml = createSearchResultElement(filterText);
            
            // 2. Filter suggested contacts below the search result
            const filteredContacts = contactsData.filter(contact =>
                contact.name.toLowerCase().includes(filterText.toLowerCase()) ||
                contact.cashtag.toLowerCase().includes(filterText.toLowerCase())
            );

            // Render the top result followed by the filtered list
            contactsList.innerHTML = searchResultHtml + filteredContacts.map(createContactElement).join('');
            
            // Ensure pay button state is correctly updated after render
            updatePayButtonState();
        }


        /**
         * Handles input change in the 'To' field.
         * @param {Event} event 
         */
        function handleSearchInput(event) {
            clearTimeout(searchTimeout);
            const searchText = event.target.value;

            // Clear existing selection and note when input changes, preparing for a new search/selection
            Array.from(document.querySelectorAll('.app-checkbox')).forEach(cb => cb.checked = false);
            noteInput.value = '';
            currentRecipientName = ''; // Clear recipient name
            
            updatePayButtonState();

            if (searchText.trim() === '') {
                renderSuggestedContacts('');
                suggestedHeader.textContent = 'Suggested';
                return;
            }

            suggestedHeader.textContent = 'Results';
            
            // Render the search result and filtered list
            searchTimeout = setTimeout(() => {
                renderSearchContact(searchText);
            }, 100); 
        }

        /**
         * Toggles the active state of the 'Pay' button based on selection.
         */
        function updatePayButtonState() {
            // Button requires a checkbox selection AND the note field must not be empty
            const anySelected = Array.from(document.querySelectorAll('.app-checkbox')).some(cb => cb.checked);
            const hasNote = noteInput.value.trim() !== '';

            if (anySelected && hasNote) {
                // Activate button
                payButton.classList.remove('opacity-50', 'cursor-not-allowed');
                payButton.classList.add('opacity-100', 'cursor-pointer', 'shadow-md');
            } else {
                // Deactivate button
                payButton.classList.remove('opacity-100', 'cursor-pointer', 'shadow-md');
                payButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        /**
         * Handles the click on the Pay button, initiating Face ID and success transition. 
         * Implements the Scanning -> Recognized ("Smile") -> Approved flow.
         */
        function handlePayClick() {
            if (payButton.classList.contains('opacity-100')) {
                const recipientDisplay = currentRecipientName || toInput.value.trim() || 'the recipient';
                
                // Get modal elements for manipulation
                const faceIdText = document.getElementById('face-id-text');
                const faceIdRing = document.getElementById('face-id-ring');
                const neutralFace = document.getElementById('icon-neutral-face');
                const approvedCheck = document.getElementById('icon-approved-check');
                
                // --- Reset State (Phase 0) ---
                faceIdText.textContent = 'Scanning Face...'; 
                
                // Ensure initial icons are correctly positioned for scanning phase
                faceIdRing.classList.remove('opacity-0');
                faceIdRing.classList.add('animate-spin', 'opacity-100');
                // Neutral face is white by default now (via CSS)
                neutralFace.classList.remove('opacity-0', 'text-app-green', 'scale-110');
                neutralFace.classList.add('text-white', 'scale-100');
                approvedCheck.classList.add('opacity-0');
                
                // 2. Show Face ID Verification Modal 
                faceIdModal.classList.add('show');
                
                const DURATION_TOTAL = 4000;
                const DELAY_RECOGNIZED = 1200; // Stop spinning, pulse/recognize
                const DELAY_APPROVED = 2500; // Switch to the final checkmark

                // --- PHASE 1 (0ms - 1200ms): Scanning ---

                // --- PHASE 2 (1200ms - 2500ms): Recognized (Simulated "Smile" and Pulse) ---
                setTimeout(() => {
                    // Stop the spinning ring
                    faceIdRing.classList.remove('animate-spin', 'opacity-100');
                    faceIdRing.classList.add('opacity-0');

                    // Simulate recognition/smile: make face green and slightly pulse
                    neutralFace.classList.remove('text-white', 'scale-100');
                    neutralFace.classList.add('text-app-green', 'scale-110'); 
                    
                    faceIdText.textContent = 'Recognized';
                }, DELAY_RECOGNIZED);

                // --- PHASE 3 (2500ms - 4000ms): Approved ---
                setTimeout(() => {
                    // Hide the recognized face icon
                    neutralFace.classList.add('opacity-0');
                    
                    // Show the final approved checkmark icon
                    approvedCheck.classList.remove('opacity-0');

                    faceIdText.textContent = 'Approved';
                }, DELAY_APPROVED);
                
                // --- FINAL (4000ms): Transition to Success Page ---
                setTimeout(() => {
                    faceIdModal.classList.remove('show'); // Hide Face ID Modal
                    
                    // 4. Update Success Page Content
                    successMessageEl.textContent = `You sent $599 to ${recipientDisplay}`;
                    
                    // 5. Show Success Page with slide-in animation (Only after Face ID is done)
                    successPage.classList.add('show');
                    
                }, DURATION_TOTAL);
            }
        }

        /**
         * Handles the custom message box display.
         * @param {string} message 
         */
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'pointer-events-none');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0', 'pointer-events-none');
            }, 2000);
        }

        /**
         * Handles the checkbox state change, populates the fields, and updates the Pay button.
         * @param {Event} event 
         * @param {string} name 
         * @param {string} cashtag 
         */
        function handleContactSelect(event, name, cashtag) {
            if (event.target.checked) {
                // Uncheck all other boxes to enforce single selection 
                Array.from(document.querySelectorAll('.app-checkbox')).forEach(cb => {
                    if (cb !== event.target) {
                        cb.checked = false;
                    }
                });
                
                // Populate fields
                toInput.value = cashtag; // Fill the 'To' field with the Cashtag
                currentRecipientName = name; // Store the user-friendly name for success message
                
                // Only pre-fill note if it's currently empty, otherwise leave user's input
                if (noteInput.value.trim() === '') {
                    noteInput.value = `Payment for ${name}`; 
                }
            } else {
                // Only clear fields if the item being unchecked is the one currently in the To input
                if (toInput.value === cashtag) {
                    noteInput.value = ''; // Clear the Note field
                    toInput.value = ''; // Clear the 'To' field
                    currentRecipientName = ''; // Clear the recipient name
                }
            }
            updatePayButtonState(); // Update button state
        }
        
        // --- Initialization ---
        window.onload = () => {
            renderSuggestedContacts(''); 
            updatePayButtonState(); 
            toInput.addEventListener('input', handleSearchInput);
            noteInput.addEventListener('input', updatePayButtonState);
        };

    </script>
</body>
</html>